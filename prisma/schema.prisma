// Keep only datasource and generator
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  avatar        String?
  isActive      Boolean   @default(true)
  isSuperAdmin  Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  workSessionsApproved WorkSession[] @relation("ApprovedBy")
  payslipsCreated      Payslip[]     @relation("CreatedBy")
  payslipsApproved     Payslip[]     @relation("ApprovedBy")
  userCompanies        UserCompany[]

  @@index([email])
  @@index([isActive])
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]
  userCompanies   UserCompany[]

  @@index([name])
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  module      String
  action      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]

  @@unique([module, action])
  @@index([module])
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model Company {
  id          String   @id @default(cuid())
  name        String
  address     String?
  phone       String?
  email       String?  @unique
  abn         String?  @unique
  tfn         String?
  logo        String?
  isActive    Boolean  @default(true)
  companyType String   @default("farm")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workLocations    WorkLocation[]
  userCompanies    UserCompany[]
  companySettings  CompanySetting[]
  departments      Department[]
  employees        Employee[]
  payslips         Payslip[]

  @@index([isActive])
  @@index([abn])
}

model UserCompany {
  id        String   @id @default(cuid())
  userId    String
  companyId String
  roleId    String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  role    Role    @relation(fields: [roleId], references: [id], onDelete: Restrict)

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@index([roleId])
}

model GlobalSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  type        String   @default("string")
  description String?
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

model CompanySetting {
  id          String   @id @default(cuid())
  companyId   String
  key         String
  value       String
  type        String   @default("string")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, key])
  @@index([companyId])
  @@index([key])
}

model WorkLocation {
  id            String   @id @default(cuid())
  companyId     String
  name          String
  type          String   @default("farm")
  address       String?
  suburb        String?
  state         String?
  postcode      String?
  cropType      String?
  farmSize      String?
  contactPerson String?
  contactPhone  String?
  contactEmail  String?
  description   String?
  notes         String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company                     Company                      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employeeLocationAssignments EmployeeLocationAssignment[]
  workSessions                WorkSession[]

  @@unique([companyId, name])
  @@index([companyId])
  @@index([isActive])
  @@index([state])
}

model Department {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employees Employee[]

  @@unique([companyId, name])
  @@index([companyId])
}

model Employee {
  id                      String    @id @default(cuid())
  companyId               String
  departmentId            String?
  employeeCode            String
  firstName               String
  lastName                String
  email                   String
  phone                   String?
  address                 String?
  birthDate               DateTime?
  tfn                     String?
  abn                     String?
  bankName                String?
  bsb                     String?
  accountNumber           String?
  accountName             String?
  visaType                String?
  visaNumber              String?
  visaExpiry              DateTime?
  passportNumber          String?
  nationality             String?
  isAustralianResident    Boolean   @default(false)
  claimsTaxFreeThreshold  Boolean   @default(false)
  hasHELPDebt             Boolean   @default(false)
  position                String
  employmentType          String    @default("casual")
  joinDate                DateTime
  endDate                 DateTime?
  paymentMethod           String    @default("hourly")
  hourlyRate              Decimal?  @db.Decimal(10, 2)
  casualLoading           Decimal   @default(0.25) @db.Decimal(5, 2)
  pieceRateUnit           String?
  pieceRate               Decimal?  @db.Decimal(10, 4)
  superFund               String?
  superMemberNumber       String?
  superRate               Decimal   @default(0.11) @db.Decimal(5, 4)
  emergencyContactName    String?
  emergencyContactPhone   String?
  emergencyContactRelation String?
  isActive                Boolean   @default(true)
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  company                     Company                      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department                  Department?                  @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  employeeLocationAssignments EmployeeLocationAssignment[]
  workSessions                WorkSession[]
  payslips                    Payslip[]
  employeeAllowances          EmployeeAllowance[]
  employeeDeductions          EmployeeDeduction[]

  @@unique([companyId, employeeCode])
  @@unique([companyId, email])
  @@index([companyId])
  @@index([departmentId])
  @@index([isActive])
  @@index([visaExpiry])
  @@index([tfn])
}

model EmployeeLocationAssignment {
  id                 String    @id @default(cuid())
  employeeId         String
  workLocationId     String
  startDate          DateTime
  endDate            DateTime?
  assignmentType     String    @default("temporary")
  positionAtSite     String?
  hourlyRateOverride Decimal?  @db.Decimal(10, 2)
  pieceRateOverride  Decimal?  @db.Decimal(10, 4)
  isActive           Boolean   @default(true)
  notes              String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  workLocation WorkLocation @relation(fields: [workLocationId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([workLocationId])
  @@index([startDate, endDate])
  @@index([isActive])
}


model WorkSession {
  id               String    @id @default(cuid())
  employeeId       String
  workLocationId   String
  workDate         DateTime
  startTime        DateTime
  endTime          DateTime?
  totalHours       Decimal?  @db.Decimal(5, 2)
  breakMinutes     Int       @default(0)
  workMinutes      Int?
  hourlyRate       Decimal?  @db.Decimal(10, 2)
  casualLoading    Decimal?  @db.Decimal(5, 2)
  hourlyEarnings   Decimal?  @db.Decimal(10, 2)
  quantityPicked   Decimal?  @db.Decimal(10, 2)
  unit             String?
  pieceRate        Decimal?  @db.Decimal(10, 4)
  pieceEarnings    Decimal?  @db.Decimal(10, 2)
  overtimeHours    Decimal?  @db.Decimal(5, 2)
  overtimeRate     Decimal?  @db.Decimal(10, 2)
  overtimeEarnings Decimal?  @db.Decimal(10, 2)
  grossEarnings    Decimal   @db.Decimal(10, 2)
  taskType         String?
  cropType         String?
  rowNumber        String?
  status           String    @default("pending")
  rejectionReason  String?
  approvedById     String?
  approvedAt       DateTime?
  employeeNotes    String?
  supervisorNotes  String?
  weatherCondition String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  employee     Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  workLocation WorkLocation  @relation(fields: [workLocationId], references: [id], onDelete: Cascade)
  approvedBy   User?         @relation("ApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)

  @@index([employeeId])
  @@index([workLocationId])
  @@index([workDate])
  @@index([status])
  @@index([createdAt])
}

model AllowanceType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  isTaxable   Boolean  @default(true)
  category    String   @default("other")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  employeeAllowances EmployeeAllowance[]
  payslipAllowances  PayslipAllowance[]

  @@index([isActive])
  @@index([category])
}

model DeductionType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  category    String   @default("other")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  employeeDeductions EmployeeDeduction[]
  payslipDeductions  PayslipDeduction[]

  @@index([isActive])
  @@index([category])
}

model EmployeeAllowance {
  id              String    @id @default(cuid())
  employeeId      String
  allowanceTypeId String
  amount          Decimal   @db.Decimal(10, 2)
  isRecurring     Boolean   @default(true)
  isActive        Boolean   @default(true)
  startDate       DateTime
  endDate         DateTime?
  description     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  employee      Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  allowanceType AllowanceType @relation(fields: [allowanceTypeId], references: [id], onDelete: Restrict)

  @@index([employeeId])
  @@index([allowanceTypeId])
  @@index([isActive])
}

model EmployeeDeduction {
  id              String    @id @default(cuid())
  employeeId      String
  deductionTypeId String
  amount          Decimal   @db.Decimal(10, 2)
  isRecurring     Boolean   @default(true)
  isActive        Boolean   @default(true)
  startDate       DateTime
  endDate         DateTime?
  remainingAmount Decimal?  @db.Decimal(10, 2)
  description     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  employee      Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  deductionType DeductionType @relation(fields: [deductionTypeId], references: [id], onDelete: Restrict)

  @@index([employeeId])
  @@index([deductionTypeId])
  @@index([isActive])
}

model Payslip {
  id              String    @id @default(cuid())
  companyId       String
  employeeId      String
  payPeriodStart  DateTime
  payPeriodEnd    DateTime
  payDate         DateTime
  ordinaryHours   Decimal   @default(0) @db.Decimal(10, 2)
  ordinaryRate    Decimal   @default(0) @db.Decimal(10, 2)
  ordinaryPay     Decimal   @default(0) @db.Decimal(10, 2)
  casualLoading   Decimal   @default(0) @db.Decimal(10, 2)
  overtimeHours   Decimal   @default(0) @db.Decimal(10, 2)
  overtimeRate    Decimal   @default(0) @db.Decimal(10, 2)
  overtimePay     Decimal   @default(0) @db.Decimal(10, 2)
  pieceRateEarnings Decimal @default(0) @db.Decimal(10, 2)
  totalAllowances Decimal   @default(0) @db.Decimal(10, 2)
  grossPay        Decimal   @db.Decimal(10, 2)
  paygTax         Decimal   @default(0) @db.Decimal(10, 2)
  totalDeductions Decimal   @default(0) @db.Decimal(10, 2)
  superAmount     Decimal   @default(0) @db.Decimal(10, 2)
  superRate       Decimal   @default(0.11) @db.Decimal(5, 4)
  netPay          Decimal   @db.Decimal(10, 2)
  ytdGross        Decimal   @default(0) @db.Decimal(12, 2)
  ytdTax          Decimal   @default(0) @db.Decimal(12, 2)
  ytdSuper        Decimal   @default(0) @db.Decimal(12, 2)
  status          String    @default("draft")
  paymentMethod   String    @default("bank_transfer")
  paymentReference String?
  notes           String?
  createdById     String
  approvedById    String?
  approvedAt      DateTime?
  paidAt          DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee  Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  createdBy User    @relation("CreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  approvedBy User?  @relation("ApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)

  payslipAllowances PayslipAllowance[]
  payslipDeductions PayslipDeduction[]

  @@unique([companyId, employeeId, payPeriodStart, payPeriodEnd])
  @@index([companyId])
  @@index([employeeId])
  @@index([status])
  @@index([payDate])
}

model PayslipAllowance {
  id              String   @id @default(cuid())
  payslipId       String
  allowanceTypeId String
  amount          Decimal  @db.Decimal(10, 2)
  hours           Decimal? @db.Decimal(10, 2)
  rate            Decimal? @db.Decimal(10, 2)
  description     String?
  createdAt       DateTime @default(now())

  payslip       Payslip       @relation(fields: [payslipId], references: [id], onDelete: Cascade)
  allowanceType AllowanceType @relation(fields: [allowanceTypeId], references: [id], onDelete: Restrict)

  @@index([payslipId])
  @@index([allowanceTypeId])
}

model PayslipDeduction {
  id              String   @id @default(cuid())
  payslipId       String
  deductionTypeId String
  amount          Decimal  @db.Decimal(10, 2)
  description     String?
  createdAt       DateTime @default(now())

  payslip       Payslip       @relation(fields: [payslipId], references: [id], onDelete: Cascade)
  deductionType DeductionType @relation(fields: [deductionTypeId], references: [id], onDelete: Restrict)

  @@index([payslipId])
  @@index([deductionTypeId])
}